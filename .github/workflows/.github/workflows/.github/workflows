name: Auto-label by project column

on:
  workflow_dispatch:
  issues:
    types: [edited]
  projects_v2_item:
    types: [updated]

jobs:
  label-by-column:
    runs-on: ubuntu-latest

    steps:
      - name: Get project item info
        uses: actions/github-script@v7
        id: project
        with:
          script: |
            const itemId = context.payload.projects_v2_item?.id;
            if (!itemId) return null;

            const query = `
              query($id: ID!) {
                node(id: $id) {
                  ... on ProjectV2Item {
                    fieldValues(first: 20) {
                      nodes {
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                        }
                      }
                    }
                  }
                }
              }
            `;
            const result = await github.graphql(query, { id: itemId });
            return result.node.fieldValues.nodes.find(f => f?.name)?.name;

      - name: Apply label according to column
        uses: actions/github-script@v7
        if: steps.project.outputs.result != null
        with:
          script: |
            const column = steps.project.outputs.result;

            const labelMap = {
              "Backlog": "Backlog",
              "ToDo": "Todo",
              "In Progress": "In Progress",
              "Done": "done"
            };

            const labelToApply = labelMap[column];

            if (labelToApply) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.projects_v2_item.content.number,
                labels: [labelToApply]
              });
            }
